<!DOCTYPE html>
<html lang="nb-NO">
<head>
  <meta charset="UTF-8">
  <title>Søknad om foreldrepenger | NAV</title>
  <link rel="stylesheet" href="../styles/parental.css"/>
</head>
<body class="application-gender-female">

<header>
  <!-- TODO: This is wrong -->
  <h1>Søknad om foreldrepenger i forbindelse med fødsel</h1>
</header>

<!-- this is not really needed -->
<script id="applicantTemplate" type="text/x-handlebars-template">
  <section id="applicant">
    <h2>Hei {{name}}</h2>
  </section>
  <section id="personalInformation">

    <div>
      <h2>Addresse</h2>
      <p>{{address.streetAddress}}</p>
      <p>{{address.postalCode}} {{address.postalArea}}</p>
    </div>

    <div>
      <h2>Telefon</h2>
      <p>{{contactPhone}}</p>
      <h2>E-post</h2>
      <p>{{email}}</p>
    </div>

    <div>
      <h2>Kontonummer</h2>
      <p>{{accountNumber}}</p>
    </div>

    <div>
      <button>Endre</button>
    </div>
  </section>
</script>

<main>
  <script id="leavePeriodTemplate" type="text/x-handlebars-template">
    <div class="leavePeriod {{type}}">
      <div><label>Fra og med<input type="date" required name="application[{{type}}][][startDate]" class="startDate" /></label></div>
      <div><label>Til og med<input type="date" required name="application[{{type}}][][endDate]" class="endDate" /></label></div>
      <div class="dayCount"></div>
    </div>
  </script>



</main>

<footer id="notificationArea"></footer>
<footer id="submit">
  <button id="saveApplication">Lagre søknad</button>
  <button id="submitApplication">Fullfør søknad</button>
</footer>

<script>
  function plusWeeksIso(date, weeks) {
    return new Date(date).addWeeks(weeks).toISODate();
  }

  Date.prototype.toISODate = function toISODate() {
    return this.toString("yyyy-MM-dd");
  };


  $(function () {
    var leavePeriodTemplate = Handlebars.compile($("#leavePeriodTemplate").html());

    function populateLeaveCategory(leaveCategory, leaveEntries) {
      if (!leaveEntries) {
        return;
      }
      for (var i=0; i<leaveEntries.length; i++) {
        addPeriod(leaveCategory,
                new Date(leaveEntries[i].startDate),
                undefined,
                new Date(leaveEntries[i].endDate));
      }
      calculateDateRanges(leaveCategory);
    }

    function addPeriod(leaveCategory, startDate, days, endDate) {
      if (!endDate) {
        days = days || parseInt(leaveCategory.data("allowed-days"));
        endDate = new Date(startDate).addDays(days);
      } else {
        days = Math.round((endDate - startDate)/(1000*60*60*24));
      }

      leaveCategory.append(leavePeriodTemplate({type: leaveCategory.data("leave-type")}));
      leaveCategory.find(".startDate:last")
              .val(startDate.toISODate())
              .attr("min", startDate.toISODate());
      leaveCategory.find(".endDate:last")
              .val(endDate.toISODate())
              .attr("min", new Date(startDate).addDays(1).toISODate())
              .attr("max", endDate.toISODate());
      if (days) {
        leaveCategory.find(".dayCount:last").text(days + " dager");
      }
    }

    function updateLeavePeriod(leavePeriod, remainingDays) {
      var startDate = Date.parse(leavePeriod.find(".startDate").val());
      var endDate = Date.parse(leavePeriod.find(".endDate").val());
      leavePeriod.find(".endDate").attr("max", new Date(startDate).addDays(remainingDays).toISODate());
      var leaveDays = Math.round((endDate - startDate)/(1000*60*60*24));
      leavePeriod.find(".dayCount").text(leaveDays + " dager");
      return leaveDays;
    }

    function calculateDateRanges(leaveCategory) {
      var remainingDays = parseInt(leaveCategory.data("allowed-days"));
      leaveCategory.find(".leavePeriod").each(function() {
        remainingDays -= updateLeavePeriod($(this), remainingDays);
      });
      return remainingDays;
    }

    var body = $("body");

    body.on("change", ".optionalToggle", function () {
      if ($(this).val() === "true") {
        $(this).closest("div").find(".optionalInformation").show(500);
      } else {
        $(this).closest("div").find(".optionalInformation").hide(500);
      }
    });

    body.on("change", "#dueDate", function () {
      var leaveCategory = $("#maternityLeave");
      var dueDate = Date.parse($(this).val());
      var startDate = new Date(dueDate).addWeeks(-3);

      leaveCategory.empty();
      addPeriod(leaveCategory, startDate);
      leaveCategory.find(".startDate")
              .attr("min", new Date(dueDate).addWeeks(-12).toISODate())
              .attr("max", startDate.toISODate());
      addPeriod($("#parentalLeave").empty(),
              new Date(leaveCategory.find(".endDate:last").val()).addDays(1));
    });

    body.on("click", "#applicationForm h1", function() {
      $(this).closest("section").find(".details").toggle();
    });

    body.on("change", ".leaveCategory .startDate", function() {
      var leaveCategory = $(this).closest(".leaveCategory");

      var date = Date.parse($(this).val());
      $(this).closest(".leavePeriod").nextAll().remove();
      $(this).closest(".leavePeriod").find(".endDate").val(null);

      var remainingDays = parseInt(leaveCategory.data("allowed-days"));
      if (!remainingDays) return;

      $(this).closest(".leavePeriod").prevAll().each(function() {
        remainingDays -= updateLeavePeriod($(this), remainingDays);
      });

      $(this).closest(".leavePeriod").find(".endDate")
              .attr("min", date.toISODate())
              .attr("max", new Date(date).addDays(remainingDays).toISODate())
              .val(new Date(date).addDays(remainingDays).toISODate());
      $(this).closest(".leavePeriod").find(".dayCount").text(remainingDays + " dager");
    });

    body.on("change", ".leaveCategory .endDate", function() {
      var leaveCategory = $(this).closest(".leaveCategory");

      $(this).closest(".leavePeriod").nextAll().remove();
      var endDate = Date.parse($(this).val());

      var remainingDays = calculateDateRanges(leaveCategory);
      if (remainingDays > 0) {
        addPeriod(leaveCategory, new Date(endDate).addDays(1), remainingDays);
      }
    });

    body.on("change", "#maternityLeave .startDate, #maternityLeave .endDate", function() {
      var leaveCategory = $("#parentalLeave");
      leaveCategory.empty();

      var startDate = new Date($("#maternityLeave .endDate:last").val()).addDays(1);
      addPeriod(leaveCategory, startDate);
    });

    body.on("change", "#coveragePercentage", function() {
      var sharedQuota = $("#sharedQuota");
      sharedQuota.empty().append($("<option>(Velg)</option>"));
      for (var i=0; i<=parseInt($(this).val())-20; i++) {
        sharedQuota.append($("<option value='" + i + "'>" + i + " uker</option>"));
      }
    });

    body.on("change", "#sharedQuota", function() {
      var leaveCategory = $("#parentalLeave");
      leaveCategory.data("allowed-days", parseInt($(this).val())*7);
      leaveCategory.empty();
      var startDate = new Date($("#maternityLeave").find(".endDate:last").val()).addDays(1);
      addPeriod(leaveCategory, startDate);
    });

    body.on("click", "#saveApplication", function (e) {
      e.preventDefault();
      serverAPI.putJSON("applications/", id, $("#applicationForm").serializeObject())
              .fail(function () {
                alert("error");
              });
    });

    $('#notificationArea').click(function() {
      $(this).fadeOut(350);
    }).hover(function() {
      $(this).stop(true).fadeIn();
    }, function() {
      $(this).stop(true).delay(5000).fadeOut(2000);
    });

    body.on("change", "input[type=radio]", function() {
      $(this).closest(".radioGroup").removeClass("invalid");
    });
    body.on("change", "input", function() {
      $(this).toggleClass("invalid", !this.validity.valid);
    });

    body.on("click", "#submitApplication", function(e) {
      e.preventDefault();
      if (!$("#applicationForm")[0].checkValidity()) {
        var message = $("<div class='warn'><span class='icon fa'></span> <h2>Feil:</h2> Fyll inn alle feltene</div>");
        $("#notificationArea").stop(true).hide().empty().append(message)
                .slideDown(300).delay(5000).fadeOut(2500);

        $(":invalid").closest(".details").show();
        $("input[type=radio]:invalid").closest(".radioGroup").addClass("invalid");
        $("input:invalid").addClass("invalid");
      } else {
        var object = $("#applicationForm").serializeObject();
        object.status = "submit";
        serverAPI.putJSON("applications/", id, object)
                .then(function() {
                  window.location.hash = "applications";
                }).fail(function () {
                  alert("error");
                });
      }
    });

    var applicantTemplate = Handlebars.compile($("#applicantTemplate").html());

    var id = currentId();

    serverAPI.getJSON("applications/" + id).then(function (data) {
      serverAPI.getHTML("application-types/" + data.applicationType + ".html").then(function(html) {
        var applicationFormTemplate = Handlebars.compile(html);
        var application = data.application;
        application.expectedChildren = application.expectedChildren || 1;
        $("main").empty()
                .append(applicantTemplate(data.applicant))
                .append(applicationFormTemplate(application));

        var sharedQuota = $("#sharedQuota");
        for (var i=0; i<=parseInt(application.coveragePercentage || 49)-20; i++) {
          sharedQuota.append($("<option value='" + i + "'>" + i + " uker</option>"));
        }

        $("input[type=checkbox][data-current-value]").each(function () {
          var e = $(this);
          var checked = e.data("current-value").split(",");
          e.attr("checked", checked.indexOf(e.val()) >= 0);
        });
        $("input[type=radio][data-current-value]").each(function () {
          var e = $(this);
          e.attr("checked", e.val() == e.data("current-value").toString());
        });
        $("select[data-current-value]").each(function () {
          var e = $(this);
          e.find("option[value='" + e.data("current-value") + "']").attr("selected", "selected");
        });
        $(".optionalInformation").hide();
        $(".optionalToggle[value=true]:checked").each(function () {
          $(this).closest("div").find(".optionalInformation").show();
        });

        var maternityLeave = $("#maternityLeave");
        populateLeaveCategory(maternityLeave, application.maternityLeave);
        maternityLeave.find(".startDate:first")
                .attr("min", new Date(application.dueDate).addWeeks(-12).toISODate())
                .attr("max", new Date(application.dueDate).addWeeks(-3).toISODate());

        var leaveCategory = $("#parentalLeave");
        leaveCategory.data("allowed-days", parseInt(sharedQuota.val())*7);
        populateLeaveCategory(leaveCategory, application.parentalLeave);
        leaveCategory.find(".startDate:first")
                .attr("min", new Date(maternityLeave.find(".endDate:last").val()).addDays(1).toISODate());

        $(".leaveCategory .leavePeriod:not(:first-child)").each(function() {
          var pastEnd = $(this).prev().find(".endDate").val();
          $(this).find(".startDate").attr("min", new Date(pastEnd).addDays(1).toISODate());
        });
      });
    }).fail(function(jqXHR, textStatus, errorThrown) {
      var message = $("<div class='error'><span class='icon fa'></span> <h2>Error:</h2> " + errorThrown + "</div>");
      $("#notificationArea").stop(true).hide().empty().append(message)
              .slideDown(300).delay(5000).fadeOut(2500);
    });
  });
</script>
</body>
</html>
