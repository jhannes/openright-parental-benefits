<!DOCTYPE html>
<html lang="nb-NO">
<head>
  <meta charset="UTF-8">
  <title>Søknad om foreldrepenger | NAV</title>
  <link rel="stylesheet" href="../styles/parental.css"/>
</head>
<body class="application-gender-female">

<header>
  <h1>Søknad om foreldrepenger i forbindelse med fødsel</h1>
</header>

<script id="applicantTemplate" type="text/x-handlebars-template">
  <section id="applicant">
    <h2>Hei {{name}}</h2>
  </section>
  <section id="personalInformation">

    <div>
      <h2>Addresse</h2>
      <p>{{address.streetAddress}}</p>
      <p>{{address.postalCode}} {{address.postalArea}}</p>
    </div>

    <div>
      <h2>Telefon</h2>
      <p>{{contactPhone}}</p>
      <h2>E-post</h2>
      <p>{{email}}</p>
    </div>

    <div>
      <h2>Kontonummer</h2>
      <p>{{accountNumber}}</p>
    </div>

    <div>
      <button>Endre</button>
    </div>
  </section>
</script>

<main>
  <script id="leavePeriodTemplate" type="text/x-handlebars-template">
    <div class="leavePeriod {{type}}">
      <div><label>Fra og med<input type="date" required name="application[{{type}}][][startDate]" class="startDate" /></label></div>
      <div><label>Til og med<input type="date" required name="application[{{type}}][][endDate]" class="endDate" /></label></div>
      <div class="dayCount"></div>
    </div>
  </script>

  <script id="applicationFormTemplate" type="text/x-handlebars-template">

    <form id="applicationForm">


      <section id="applicationCategory">
        <h2>Hva søker du om?</h2>
        <select name="application[applicationType]" id="applicationType" data-current-value="{{applicationType}}">
          <option class="gender-female" value="application-maternity-benefits">Foreldrepenger og mødrekvote til mor
          </option>
          <option class="gender-female" value="application-maternity-benefits-single">Foreldrepenger til mor med
            aleneomsorg
          </option>
          <option class="gender-female" value="application-co-maternity-benefits">Foreldrepenger til medmor</option>
          <option class="gender-female" value="application-co-maternity-benefits-single">Foreldrepenger til medmor med
            aleneomsorg
          </option>
          <option class="gender-female" value="application-co-maternity-leave">Fedrekvote til medmor</option>
          <option class="gender-male" value="application-paternity-benefits">Foreldrepenger og fedrekvote til far
          </option>
          <option class="gender-male" value="application-paternity-benefits-single">Foreldrepenger og fedrekvote til far
            med aleneomsorg
          </option>
          <option value="application-one-time-benefits">Engangsstønad</option>
        </select>
      </section>

      <section id="residency">
        <h1>Oppholdsted</h1>

        <div class="details">
          <h2>Oppholder du deg i Norge?</h2>
          <div class="radioGroup">
            <label><input type="radio" required name="application[domesticResidency]" value="true"
                          data-current-value="{{domesticResidency}}">Ja</label>
            <label><input type="radio" required name="application[domesticResidency]" value="false"
                          data-current-value="{{domesticResidency}}">Nei</label>
          </div>

          <div>
            <h2>Har du oppholdt deg sammenhengende i Norge de siste 12 månedene? <a class="explanation"></a></h2>
            <div class="radioGroup">
              <label><input type="radio" required class="optionalToggle" name="application[nonDomestic][pastStay]"
                            value="false"
                            data-current-value="{{nonDomestic.pastStay}}">Ja</label>
              <label><input type="radio" required class="optionalToggle" name="application[nonDomestic][pastStay]"
                            value="true"
                            data-current-value="{{nonDomestic.pastStay}}">Nei</label>

              <div class="optionalInformation">
                <label for="country-past-location">Hvilket land har du opphold deg i?</label>
                <textarea id="country-past-location" name="application[nonDomestic][pastLocation]">{{nonDomestic.pastLocation}}</textarea>
              </div>
            </div>
          </div>


          <div>
            <h2>Kommer du til å oppholde deg sammenhengende i Norge de neste 12 månedene eller mer? <a
                    class="explanation"></a></h2>
            <div class="radioGroup">
              <label><input type="radio" required class="optionalToggle" name="application[nonDomestic][plannedStay]"
                            value="false"
                            data-current-value="{{nonDomestic.plannedStay}}">Ja</label>
              <label><input type="radio" required class="optionalToggle" name="application[nonDomestic][plannedStay]"
                            value="true"
                            data-current-value="{{nonDomestic.plannedStay}}">Nei</label>

              <div class="optionalInformation">
                <label for="country-future-location">Hvilket land skal du oppholde deg i?</label>
                            <textarea id="country-future-location" name="application[nonDomestic][plannedLocation]"
                                    >{{nonDomestic.plannedLocation}}</textarea>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="income">
        <h1>Arbeid og/eller annen inntekt</h1>

        <div class="details">
          <h2>Har du vært i arbeid de siste 10 månedene før du starter uttaket av feriepengene? <a
                  class="explanation"></a></h2>

          <div class="radioGroup">
            <label><input type="radio" required class="optionalToggle" name="application[workedLast10Months]" value="true"
                          data-current-value="{{workedLast10Months}}">Ja</label>
            <label><input type="radio" required class="optionalToggle" name="application[workedLast10Months]"
                          value="false"
                          data-current-value="{{workedLast10Months}}">Nei</label>

            <div class="subform-container optionalInformation">
              <h2>Arbeidsforhold 1</h2>
              <label><input type="radio" name="application[income][][employerType]" value="employer">Arbeidstaker</label>
              <label><input type="radio" name="application[income][][employerType]" value="selfEmployed">Selvstendig
                næringsdrivende</label>

              <div>
                <label for="employer-name">Arbeidsgiver eller næringsvirksomhet</label>

                <p><input id="employer-name" type="text" name="application[income][][employerName]"/></p>
              </div>

              <div>
                <label for="employment-percentage">Stilingsprosent</label>

                <p><input id="employment-percentage" type="number" min="1" max="100" value="100"
                          name="application[income][][employmentPercent]"/></p>
              </div>

              <div>
                <h2>Arbeidsinntekt</h2>
                <div class="radioGroup">
                  <label><input type="radio" name="application[income][][paySchedule]" value="weekly">Ukentlig</label>
                  <label><input type="radio" name="application[income][][paySchedule]" value="biweekly">Hver 14. dag</label>
                  <label><input type="radio" name="application[income][][paySchedule]" value="monthly">Månedlig</label>
                </div>
              </div>

              <div>
                <label for="employment-salary">Siste arbeidsinntekt</label>

                <p><input id="employment-salary" type="number" name="application[income][][salary]"/></p>
              </div>

              <div>
                <label for="employment-start-date">Startdato</label>

                <p><input id="employment-start-date" type="date" required name="application[income][][startDate]"/></p>
              </div>

              <div>
                <label for="employment-end-date">Sluttdato (kun hvis arbeidsforholdet er avsluttet)</label>

                <p><input id="employment-end-date" type="date" name="application[income][][endDate]"/></p>
              </div>

              <p>PS! Husk at arbeidsgiver må sende inn inntektopplysninger</p>
            </div>

            <div class="optionalInformation">
              <button>Legg til arbeidsforhold</button>
            </div>

            <div class="optionalInformation">
              <h2>Har du hatt andre inntektskilder de siste 10 månedene før du starter uttaket av ferienepengene?</h2>
              <label><input type="checkbox" name="application[otherIncome][]" value="benefits"
                            data-current-value="{{otherIncome}}">Syke-, pleie- og omsorgspenger, arbeidsavklaringspenger,
                svangerskap- eller foreldrepenger</label>
              <label><input type="checkbox" name="application[otherIncome][]" value="unemployment"
                            data-current-value="{{otherIncome}}">Dagpenger under arbeidsløshet</label>
              <label><input type="checkbox" name="application[otherIncome][]" value="studentIncome"
                            data-current-value="{{otherIncome}}">Lønn under utdanning</label>
              <label><input type="checkbox" name="application[otherIncome][]" value="afterPay"
                            data-current-value="{{otherIncome}}">Etterlønn fra arbeidsgiver</label>
              <label><input type="checkbox" name="application[otherIncome][]" value="militaryService"
                            data-current-value="{{otherIncome}}">Militær- eller siviltjeneste</label>
              <label><input type="checkbox" name="application[otherIncome][]" value="waitPay"
                            data-current-value="{{otherIncome}}">Ventelønn eller vartpenger</label>
            </div>
          </div>
        </div>
      </section>

      <section id="permissionPeriod">
        <h1>Permisjonsperiode</h1>

        <div class="details">
          <div class="gender-female">
            <h2>Når har du termin</h2>

            <p><input type="date" required name="application[dueDate]" id="dueDate" value="{{dueDate}}" min="2015-05-10"/>
            </p>


            <h2>Hvor mange barn venter du?</h2>

            <p><input width="1" type="number" min="1" name="application[expectedChildren]"
                      required
                      value="{{expectedChildren}}"/></p>
          </div>

          <h2>Hvilken dekningsgrad ønsker du? <a class="explanation"
                                                 title="Foreldrene må velge lik dekningsgrad. Denne vil gjelde for hele stønadsperioden og kan ikke endres. Dekningsgrad på 100% gir en høyere samlet utbetaling enn 80%"></a>
          </h2>

          <p>
            <select name="application[coveragePercentage]" id="coveragePercentage" data-current-value="{{coveragePercentage}}">
              <option value="59">80% dekningsgrad i 59 uker</option>
              <option value="49" selected>100% dekningsgrad i 49 uker</option>
            </select>
          </p>

          <div id="leavePlan">

            <h2>Mors kvote (10 uker)</h2>

            <div id="maternityLeave" class="leaveCategory" data-leave-type="maternityLeave" data-allowed-days="70">
            </div>

            <h2>Felleskvote</h2>

            <label for="sharedQuota">Hvor mange uker av felleskvoten skal mor ta ut?</label>
            <select id="sharedQuota" name="application[sharedQuota]" required data-current-value="{{sharedQuota}}">
              <option>(Velg)</option>
            </select>

            <div id="parentalLeave" class="leaveCategory" data-leave-type="parentalLeave" >
            </div>

            <h2>Fars kvote (10 uker)</h2>

            <p>Søker du om overføring av fedrekvoten (10 uker) til deg?</p>

            <div class="radioGroup">

              <label><input type="radio" required class="optionalToggle"
                            name="application[paternityLeave][convertPaternity][convertPaternityLeaveToMaternityLeave]"
                            value="true"
                            data-current-value="{{paternityLeave.convertPaternity.convertPaternityLeaveToMaternityLeave}}">Ja</label>
              <label><input type="radio" required class="optionalToggle"
                            name="application[paternityLeave][convertPaternity][convertPaternityLeaveToMaternityLeave]"
                            value="false"
                            data-current-value="{{paternityLeave.convertPaternity.convertPaternityLeaveToMaternityLeave}}">Nei</label>

              <div class="optionalInformation">

                <div id="paternityLeave" class="leaveCategory" data-leave-type="paternityLeave" >
                </div>

                <h2>Årsak til overføring av fedrekvote</h2>
                <div class="radioGroup">
                  <label><input type="radio" name="application[leavePeriod][convertPaternity][reason]" value="singleParent"
                                data-current-value="{{leavePeriod.convertPaternity.reason}}">Aleneomsorg for
                    barnet/barna</label>
                  <label><input type="radio" name="application[leavePeriod][convertPaternity][reason]"
                                value="fatherNotEligible"
                                data-current-value="{{leavePeriod.convertPaternity.reason}}">Far har ikke rett til
                    foreldrepenger</label>
                  <label><input type="radio" name="application[leavePeriod][convertPaternity][reason]"
                                value="fatherInstitutionalized"
                                data-current-value="{{leavePeriod.convertPaternity.reason}}">Far er innlagt på
                    helseinstitusjon</label>
                  <label><input type="radio" name="application[leavePeriod][convertPaternity][reason]" value="fatherIllness"
                                data-current-value="{{leavePeriod.convertPaternity.reason}}">Far er på grunn av sykdom helt
                    avhengig av hjelp for å ta seg av barnet/barna</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="otherParent">
        <h1>Den andre forelderen</h1>

        <div class="details">

          <h2>Navn</h2>

          <p><input type="text" name="application[otherParent][name]" value="{{otherParent.name}}"/></p>

          <h2>Fødselsnummer</h2>

          <p><input type="text" pattern="[0-9]{12}" name="application[otherParent][personNumber]"
                    value="{{otherParent.personNumber}}"/></p>

          <h2>Er den andre forelderen gjort kjent med hvilke perioder med foreldrepenger du har søkt om?</h2>
          <div class="radioGroup">
            <label><input type="radio" name="application[otherParent][isInformed]" value="true"
                          data-current-value="{{otherParent.isInformed}}">Ja</label>
            <label><input type="radio" name="application[otherParent][isInformed]" value="false"
                          data-current-value="{{otherParent.isInformed}}">Nei</label>
          </div>
        </div>
      </section>

      <section id="additionalInformation">
        <h1>Eventuelle tilleggsopplysninger</h1>

        <div class="details">
          <h2>Er det noe som ikke er gjort rede for i skjemaet som du mener NAV burde være klar over?</h2>

          <p><textarea cols=60 rows=6 name="application[otherInformation]">{{otherInformation}}</textarea></p>
        </div>
      </section>
    </form>
  </script>


</main>

<footer id="notificationArea"></footer>
<footer id="submit">
  <button id="saveApplication">Lagre søknad</button>
  <button id="submitApplication">Fullfør søknad</button>
</footer>

<script>
  function plusWeeksIso(date, weeks) {
    return new Date(date).addWeeks(weeks).toISODate();
  }

  Date.prototype.toISODate = function toISODate() {
    return this.toString("yyyy-MM-dd");
  };


  $(function () {
    var leavePeriodTemplate = Handlebars.compile($("#leavePeriodTemplate").html());

    function populateLeaveCategory(leaveCategory, leaveEntries) {
      if (!leaveEntries) {
        return;
      }
      for (var i=0; i<leaveEntries.length; i++) {
        addPeriod(leaveCategory,
                new Date(leaveEntries[i].startDate),
                undefined,
                new Date(leaveEntries[i].endDate));
      }
      calculateDateRanges(leaveCategory);
    }

    function addPeriod(leaveCategory, startDate, days, endDate) {
      if (!endDate) {
        days = days || parseInt(leaveCategory.data("allowed-days"));
        endDate = new Date(startDate).addDays(days);
      } else {
        days = Math.round((endDate - startDate)/(1000*60*60*24));
      }

      leaveCategory.append(leavePeriodTemplate({type: leaveCategory.data("leave-type")}));
      leaveCategory.find(".startDate:last")
              .val(startDate.toISODate())
              .attr("min", startDate.toISODate());
      leaveCategory.find(".endDate:last")
              .val(endDate.toISODate())
              .attr("min", new Date(startDate).addDays(1).toISODate())
              .attr("max", endDate.toISODate());
      if (days) {
        leaveCategory.find(".dayCount:last").text(days + " dager");
      }
    }

    function updateLeavePeriod(leavePeriod, remainingDays) {
      var startDate = Date.parse(leavePeriod.find(".startDate").val());
      var endDate = Date.parse(leavePeriod.find(".endDate").val());
      leavePeriod.find(".endDate").attr("max", new Date(startDate).addDays(remainingDays).toISODate());
      var leaveDays = Math.round((endDate - startDate)/(1000*60*60*24));
      leavePeriod.find(".dayCount").text(leaveDays + " dager");
      return leaveDays;
    }

    function calculateDateRanges(leaveCategory) {
      var remainingDays = parseInt(leaveCategory.data("allowed-days"));
      leaveCategory.find(".leavePeriod").each(function() {
        remainingDays -= updateLeavePeriod($(this), remainingDays);
      });
      return remainingDays;
    }

    var body = $("body");

    body.on("change", ".optionalToggle", function () {
      if ($(this).val() === "true") {
        $(this).closest("div").find(".optionalInformation").show(500);
      } else {
        $(this).closest("div").find(".optionalInformation").hide(500);
      }
    });

    body.on("change", "#dueDate", function () {
      var leaveCategory = $("#maternityLeave");
      var dueDate = Date.parse($(this).val());
      var startDate = new Date(dueDate).addWeeks(-3);

      leaveCategory.empty();
      addPeriod(leaveCategory, startDate);
      leaveCategory.find(".startDate")
              .attr("min", new Date(dueDate).addWeeks(-12).toISODate())
              .attr("max", startDate.toISODate());
      addPeriod($("#parentalLeave").empty(),
              new Date(leaveCategory.find(".endDate:last").val()).addDays(1));
    });

    body.on("click", "#applicationForm h1", function() {
      $(this).closest("section").find(".details").toggle();
    });

    body.on("change", ".leaveCategory .startDate", function() {
      var leaveCategory = $(this).closest(".leaveCategory");

      var date = Date.parse($(this).val());
      $(this).closest(".leavePeriod").nextAll().remove();
      $(this).closest(".leavePeriod").find(".endDate").val(null);

      var remainingDays = parseInt(leaveCategory.data("allowed-days"));
      if (!remainingDays) return;

      $(this).closest(".leavePeriod").prevAll().each(function() {
        remainingDays -= updateLeavePeriod($(this), remainingDays);
      });

      $(this).closest(".leavePeriod").find(".endDate")
              .attr("min", date.toISODate())
              .attr("max", new Date(date).addDays(remainingDays).toISODate())
              .val(new Date(date).addDays(remainingDays).toISODate());
      $(this).closest(".leavePeriod").find(".dayCount").text(remainingDays + " dager");
    });

    body.on("change", ".leaveCategory .endDate", function() {
      var leaveCategory = $(this).closest(".leaveCategory");

      $(this).closest(".leavePeriod").nextAll().remove();
      var endDate = Date.parse($(this).val());

      var remainingDays = calculateDateRanges(leaveCategory);
      if (remainingDays > 0) {
        addPeriod(leaveCategory, new Date(endDate).addDays(1), remainingDays);
      }
    });

    body.on("change", "#maternityLeave .startDate, #maternityLeave .endDate", function() {
      var leaveCategory = $("#parentalLeave");
      leaveCategory.empty();

      var startDate = new Date($("#maternityLeave .endDate:last").val()).addDays(1);
      addPeriod(leaveCategory, startDate);
    });

    body.on("change", "#coveragePercentage", function() {
      var sharedQuota = $("#sharedQuota");
      sharedQuota.empty().append($("<option>(Velg)</option>"));
      for (var i=0; i<=parseInt($(this).val())-20; i++) {
        sharedQuota.append($("<option value='" + i + "'>" + i + " uker</option>"));
      }
    });

    body.on("change", "#sharedQuota", function() {
      var leaveCategory = $("#parentalLeave");
      leaveCategory.data("allowed-days", parseInt($(this).val())*7);
      leaveCategory.empty();
      var startDate = new Date($("#maternityLeave").find(".endDate:last").val()).addDays(1);
      addPeriod(leaveCategory, startDate);
    });

    body.on("click", "#saveApplication", function (e) {
      e.preventDefault();
      serverAPI.putJSON("applications/", id, $("#applicationForm").serializeObject())
              .fail(function () {
                alert("error");
              });
    });

    $('#notificationArea').click(function() {
      $(this).fadeOut(350);
    }).hover(function() {
      $(this).stop(true).fadeIn();
    }, function() {
      $(this).stop(true).delay(5000).fadeOut(2000);
    });

    body.on("change", "input[type=radio]", function() {
      $(this).closest(".radioGroup").removeClass("invalid");
    });
    body.on("change", "input", function() {
      $(this).toggleClass("invalid", !this.validity.valid);
    });

    body.on("click", "#submitApplication", function(e) {
      e.preventDefault();
      if (!$("#applicationForm")[0].checkValidity()) {
        console.log("problem with form");
        var message = $("<div class='warn'><span class='icon fa'></span> <h2>Feil:</h2> Fyll inn alle feltene</div>");
        $("#notificationArea").stop(true).hide().empty().append(message)
                .slideDown(300).delay(5000).fadeOut(2500);

        $(":invalid").closest(".details").show();
        $("input[type=radio]:invalid").closest(".radioGroup").addClass("invalid");
        $("input:invalid").addClass("invalid");
      } else {
        var object = $("#applicationForm").serializeObject();
        object.status = "submit";
        serverAPI.putJSON("applications/", id, object)
                .then(function() {
                  window.location.hash = "applications";
                }).fail(function () {
                  alert("error");
                });
      }
    });

    var applicantTemplate = Handlebars.compile($("#applicantTemplate").html());
    var applicationFormTemplate = Handlebars.compile($("#applicationFormTemplate").html());

    var id = currentId();

    serverAPI.getJSON("applications/" + id).then(function (data) {
      var application = data.application;
      application.expectedChildren = application.expectedChildren || 1;
      $("main").empty()
              .append(applicantTemplate(data.applicant))
              .append(applicationFormTemplate(application));

      var sharedQuota = $("#sharedQuota");
      for (var i=0; i<=parseInt(application.coveragePercentage || 49)-20; i++) {
        sharedQuota.append($("<option value='" + i + "'>" + i + " uker</option>"));
      }

      $("input[type=checkbox][data-current-value]").each(function () {
        var e = $(this);
        var checked = e.data("current-value").split(",");
        e.attr("checked", checked.indexOf(e.val()) >= 0);
      });
      $("input[type=radio][data-current-value]").each(function () {
        var e = $(this);
        e.attr("checked", e.val() == e.data("current-value").toString());
      });
      $("select[data-current-value]").each(function () {
        var e = $(this);
        e.find("option[value='" + e.data("current-value") + "']").attr("selected", "selected");
      });
      var maternityLeave = $("#maternityLeave");
      populateLeaveCategory(maternityLeave, application.maternityLeave);
      maternityLeave.find(".startDate:first")
              .attr("min", new Date(application.dueDate).addWeeks(-12).toISODate())
              .attr("max", new Date(application.dueDate).addWeeks(-3).toISODate());

      var leaveCategory = $("#parentalLeave");
      leaveCategory.data("allowed-days", parseInt(sharedQuota.val())*7);
      populateLeaveCategory(leaveCategory, application.parentalLeave);
      leaveCategory.find(".startDate:first")
              .attr("min", new Date(maternityLeave.find(".endDate:last").val()).addDays(1).toISODate());

      $(".leaveCategory .leavePeriod:not(:first-child)").each(function() {
        var pastEnd = $(this).prev().find(".endDate").val();
        $(this).find(".startDate").attr("min", new Date(pastEnd).addDays(1).toISODate());
      });


      $(".optionalInformation").hide();
      $(".optionalToggle[value=true]:checked").each(function () {
        $(this).closest("div").find(".optionalInformation").show();
      });
    }).fail(function(jqXHR, textStatus, errorThrown) {
      var message = $("<div class='error'><span class='icon fa'></span> <h2>Error:</h2> " + errorThrown + "</div>");
      $("#notificationArea").stop(true).hide().empty().append(message)
              .slideDown(300).delay(5000).fadeOut(2500);
    });
  });
</script>
</body>
</html>
